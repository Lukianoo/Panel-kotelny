<!doctype html>
<html lang="cs">
<head>
<meta charset="utf-8">
<title>Kotelna â€“ Attack FD 25</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Segoe UI,system-ui;
  background:linear-gradient(135deg,#1e3c72,#2a5298);
  color:#222;
}
header{
  background:#000;
  color:#fff;
  padding:15px 20px;
  display:flex;
  justify-content:space-between;
  flex-wrap:wrap;
  align-items:center;
}
main{max-width:1400px;margin:auto;padding:20px}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:20px;
}
.card{
  background:#fff;
  border-radius:14px;
  padding:20px;
  box-shadow:0 10px 30px rgba(0,0,0,.25);
}
h2{margin:0 0 10px;font-size:16px;color:#1e3c72}
.value{font-size:32px;font-weight:700;color:#d32f2f}
.sub{font-size:13px;color:#555}
.green{color:#2e7d32}
.blue{color:#1565c0}
.orange{color:#ef6c00}
input{width:100%;padding:10px;font-size:15px}
.settings{display:grid;grid-template-columns:1fr 1fr;gap:15px}
button{
  padding:12px 18px;
  font-size:15px;
  border-radius:10px;
  border:none;
  background:#1e3c72;
  color:#fff;
  cursor:pointer;
  width:100%;
  margin-bottom:10px;
}
#historyBtn{background:#ef6c00}
#monthHistoryBtn{background:#1565c0}
#totalHistoryBtn{background:#2e7d32}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;text-align:center}
th{background:#eee}

@media (max-width:600px){
  .settings{grid-template-columns:1fr}
}
</style>
</head>

<body>

<header>
  <div id="clock" style="font-size:25px;"></div>
  <div style="flex:1;text-align:center;font-size:25px;font-weight:700;">
    Attack FD 25 AUTOMAT â€“ PANEL KOTELNY
  </div>
  <button id="fullscreenBtn" style="width:auto;background:#6a1b9a">â›¶ Fullscreen</button>
</header>

<main>

<div class="grid">
  <div class="card"><h2>ğŸ”¥ Kotel</h2><div class="value" id="tKotel">--</div></div>
  <div class="card"><h2>â†©ï¸ ZpÃ¡teÄka</h2><div class="value blue" id="tZpet">--</div></div>
  <div class="card"><h2>ğŸŒ¡ï¸ TeplotnÃ­ spÃ¡d Î”T</h2><div class="value orange" id="deltaT">--</div></div>
  <div class="card"><h2>âš¡ AktuÃ¡lnÃ­ vÃ½kon</h2><div class="value green" id="powerKWbig">--</div></div>
  <div class="card"><h2>ğŸŒ¡ï¸ Venku</h2><div class="value" id="tVenku">--</div></div>
  <div class="card"><h2>â±ï¸ PodavaÄ celkem</h2><div class="value" id="feedTotal">--</div></div>
</div>

<br>

<div class="card">
<h2>ğŸ’° SpotÅ™eba uhlÃ­</h2>
<div class="grid">
  <div><div class="sub">HODINA</div><div class="value orange" id="kgHour">0 kg</div></div>
  <div><div class="sub">DNES</div><div class="value green" id="kgDay">0 kg</div></div>
  <div><div class="sub">MÄšSÃC</div><div class="value blue" id="kgMonth">0 kg</div></div>
  <div><div class="sub">CENA DNES</div><div class="value" id="costDay">0 KÄ</div></div>
  <div><div class="sub">CENA MÄšSÃC</div><div class="value" id="costMonth">0 KÄ</div></div>
</div>

<br>
<button id="historyBtn">ğŸ“… DennÃ­ historie spotÅ™eby</button>
<button id="monthHistoryBtn">ğŸ“† MÄ›sÃ­ÄnÃ­ historie spotÅ™eby</button>
<button id="totalHistoryBtn">ğŸ“ˆ CelkovÃ¡ historie spotÅ™eby</button>
</div>

<div id="historyBox" class="card" style="display:none;margin-top:20px">
  <table><tbody id="historyTable"></tbody></table>
</div>
<div id="monthHistoryBox" class="card" style="display:none;margin-top:20px">
  <table><tbody id="monthHistoryTable"></tbody></table>
</div>
<div id="totalHistoryBox" class="card" style="display:none;margin-top:20px">
  <table><tbody id="totalHistoryTable"></tbody></table>
</div>

<div class="card">
<h2>âš™ï¸ NastavenÃ­</h2>
<div class="settings">
  <div><label>Kg uhlÃ­ / 10 min</label><input type="number" id="kg10min"></div>
  <div><label>Cena / kg</label><input type="number" id="priceKg"></div>
</div>
</div>

</main>

<script>
/* ====== NASTAVENÃ KANÃLÅ® ====== */
const CHANNEL = 231269;        // hlavnÃ­ kanÃ¡l (kotel)
const OUT_CHANNEL = 774246;    // â† SEM dej ID kanÃ¡lu s venkovnÃ­ teplotou
const OUT_FIELD = 1;           // â† field ÄÃ­slo (1â€“8)

const ENERGY = 4.8;
const EFF = 0.75;

/* ====== INIT ====== */
kg10min.value = localStorage.kg10min || 2.5;
priceKg.value = localStorage.priceKg || 6.2;

function updateClock(){
  clock.textContent = new Date().toLocaleString("cs-CZ");
}

function secToHMS(sec){
  sec=Math.max(0,Math.floor(sec));
  const h=Math.floor(sec/3600);
  const m=Math.floor((sec%3600)/60);
  const s=sec%60;
  return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
}

function secToKg(sec){
  return Math.max(0,(sec/600)*(+kg10min.value||2.5));
}

async function fetchFeeds(ch, p){
  const r = await fetch(`https://api.thingspeak.com/channels/${ch}/feeds.json?${p}`);
  return (await r.json()).feeds || [];
}

/* ====== HLAVNÃ DATA ====== */
async function updateCurrent(){
  const f = (await fetchFeeds(CHANNEL,"results=1"))[0];
  if(!f) return;

  const tK = +f.field5 || 0;
  const tZ = +f.field1 || 0;

  tKotel.textContent = tK.toFixed(1)+" Â°C";
  tZpet.textContent  = tZ.toFixed(1)+" Â°C";
  deltaT.textContent = (tK-tZ).toFixed(1)+" Â°C";
  feedTotal.textContent = secToHMS(+f.field8||0);
}

/* ====== VENKOVNÃ TEPLOTA â€“ JINÃ KANÃL ====== */
async function updateOutsideTemp(){
  const f = (await fetchFeeds(OUT_CHANNEL,"results=1"))[0];
  if(!f) return;

  const t = +f[`field${OUT_FIELD}`];
  if(!isNaN(t)){
    tVenku.textContent = t.toFixed(1)+" Â°C";
  }
}

/* ====== SPOTÅ˜EBA ====== */
async function updateHour(){
  const f = await fetchFeeds(CHANNEL,"minutes=60&results=120");
  if(f.length<2) return;
  const kg = secToKg(f.at(-1).field8 - f[0].field8);
  kgHour.textContent = kg.toFixed(2)+" kg";
  powerKWbig.textContent = (kg*ENERGY*EFF).toFixed(1)+" kWh";
}

/* ====== START ====== */
updateClock();
updateCurrent();
updateOutsideTemp();
updateHour();

setInterval(updateClock,1000);
setInterval(updateCurrent,30000);
setInterval(updateOutsideTemp,300000);
setInterval(updateHour,300000);

/* ====== FULLSCREEN ====== */
fullscreenBtn.onclick = () => {
  document.fullscreenElement
    ? document.exitFullscreen()
    : document.documentElement.requestFullscreen();
};
</script>

</body>
</html>
